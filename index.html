<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0, viewport-fit=cover"
  />
  <title>Task Flow</title>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root {
      --bg: #000000;
      --text: #ffffff;
      --muted: #6b6b6b;
      --line: #1e1e1e;
      --accent: #ffffff;

      /* Telegram safe-area */
      --safe-top: env(safe-area-inset-top);
      --safe-bottom: env(safe-area-inset-bottom);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
        sans-serif;
      min-height: 100vh;
      padding-top: calc(16px + var(--safe-top));
      padding-bottom: calc(16px + var(--safe-bottom));
    }

    .app {
      max-width: 420px;
      margin: 0 auto;
      padding: 0 16px;
    }

    .stepper {
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    .step {
      display: flex;
      gap: 16px;
      align-items: flex-start;
    }

    .step-rail {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .step-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--muted);
    }

    .step-line {
      width: 2px;
      height: 36px;
      background: var(--line);
      margin-top: 6px;
    }

    .step-title {
      font-size: 14px;
      line-height: 1.4;
      padding-top: 1px;
      color: var(--muted);
    }

    .step.done .step-dot {
      background: var(--accent);
    }

    .step.active .step-dot {
      background: var(--accent);
      box-shadow: 0 0 0 6px rgba(255, 255, 255, 0.12);
    }

    .step.done .step-title,
    .step.active .step-title {
      color: var(--text);
    }
  </style>
</head>

<body>
  <div class="app">
    <div id="stepper" class="stepper"></div>
  </div>

  <script>
    /**********************************************************
     * CONFIG
     **********************************************************/
    const BACKEND_URL = "https://5-129-200-89.nip.io";
    const API_TRACK = BACKEND_URL + "/api/track";

    const tg = window.Telegram.WebApp;

    let parsedParams = null;
    let tgUser = null;

    /**********************************************************
     * STEPPER
     **********************************************************/
    const STEPS = [
      { id: "load", title: "Загрузка задания" },
      { id: "check", title: "Проверка пользователя" },
      { id: "track", title: "Фиксация отклика" },
      { id: "redirect", title: "Переадресация" }
    ];

    function renderStepper(activeIndex) {
      const root = document.getElementById("stepper");
      root.innerHTML = "";

      STEPS.forEach((step, index) => {
        let state = "pending";
        if (index < activeIndex) state = "done";
        if (index === activeIndex) state = "active";

        const el = document.createElement("div");
        el.className = `step ${state}`;

        el.innerHTML = `
          <div class="step-rail">
            <div class="step-dot"></div>
            ${
              index < STEPS.length - 1
                ? `<div class="step-line"></div>`
                : ""
            }
          </div>
          <div class="step-title">${step.title}</div>
        `;

        root.appendChild(el);
      });
    }

    /**********************************************************
     * TELEGRAM INIT
     **********************************************************/
    function initTelegram() {
      tg.ready();
      tg.expand();
      tg.setBackgroundColor("#000000");
      tg.setHeaderColor("#000000");

      if (tg.initDataUnsafe?.user) {
        tgUser = tg.initDataUnsafe.user;
      }
    }

    /**********************************************************
     * PARAM PARSE
     **********************************************************/
    function parseParams() {
      let startParam =
        tg.initDataUnsafe?.tgWebAppStartParam ||
        tg.initDataUnsafe?.start_param;

      if (!startParam) {
        const urlParams = new URLSearchParams(window.location.search);
        startParam = urlParams.get("test");
      }

      if (!startParam) return null;

      const clean = startParam.replace("tgWebAppStartParam=", "");
      const parts = clean.split("_");

      return {
        raw: clean,
        post_id: parseInt(parts[0]),
        admin_id: parseInt(parts[1]),
        ref: parts[2] || "direct",
        platform: parts[3] || "tg"
      };
    }

    /**********************************************************
     * AUTO FLOW (NO BUTTON)
     **********************************************************/
    async function autoFlow() {
      // step 0
      renderStepper(0);

      await delay(400);
      renderStepper(1);

      await delay(400);
      renderStepper(2);

      const payload = {
        startapp: parsedParams.raw,
        post_id: parsedParams.post_id,
        admin_id: parsedParams.admin_id,
        tg_user_id: tgUser?.id?.toString(),
        ref: parsedParams.ref,
        platform: parsedParams.platform,
        source: "mini_app",
        timestamp: new Date().toISOString(),
        user_data: tgUser || null
      };

      const res = await fetch(API_TRACK, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      const data = await res.json();

      if (!data.success) return;

      renderStepper(3);

      const username = data.admin_username?.replace("@", "");
      const text = `Здравствуйте! Я по поводу задания на ${parsedParams.platform}`;
      const url = `https://t.me/${username}?text=${encodeURIComponent(text)}`;

      tg.openTelegramLink(url);
    }

    function delay(ms) {
      return new Promise((r) => setTimeout(r, ms));
    }

    /**********************************************************
     * BOOT
     **********************************************************/
    document.addEventListener("DOMContentLoaded", () => {
      initTelegram();
      parsedParams = parseParams();

      renderStepper(0);

      if (parsedParams) {
        autoFlow();
      }
    });
  </script>
</body>
</html>
