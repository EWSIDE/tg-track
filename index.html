<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SHARD</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --tg-theme-bg-color: #ffffff;
            --tg-theme-secondary-bg-color: #f4f4f5;
            --tg-theme-text-color: #000000;
            --tg-theme-hint-color: #707579;
            --tg-theme-link-color: #2481cc;
            --tg-theme-button-color: #2481cc;
            --tg-theme-button-text-color: #ffffff;
            --tg-theme-header-bg-color: #ffffff;
            --tg-theme-accent-text-color: #2481cc;
            --tg-theme-section-bg-color: #ffffff;
            --tg-theme-section-separator-color: #e8e8e8;
        }

        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            line-height: 1.2;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 16px;
            text-align: center;
        }

        /* –ù–∞—Ç–∏–≤–Ω—ã–π –ª–æ–∞–¥–µ—Ä Telegram */
        .loader-wrapper {
            margin-bottom: 24px;
        }

        .spinner {
            width: 44px;
            height: 44px;
            border: 3.5px solid var(--tg-theme-secondary-bg-color);
            border-top: 3.5px solid var(--tg-theme-button-color);
            border-radius: 50%;
            animation: spin 0.8s cubic-bezier(0.445, 0.05, 0.55, 0.95) infinite;
        }

        /* –°—Ç–∏–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏—è */
        .status-title {
            font-size: 17px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .status-sub {
            font-size: 14px;
            color: var(--tg-theme-hint-color);
            max-width: 240px;
        }

        /* –û—à–∏–±–∫–∏ –≤ —Å—Ç–∏–ª–µ Empty State */
        .error-icon {
            font-size: 64px;
            margin-bottom: 16px;
            filter: grayscale(0.2);
        }

        /* –ö–Ω–æ–ø–∫–∏ –∫–∞–∫ –≤ iOS/Android Telegram */
        .footer-fixed {
            padding: 16px;
            background: var(--tg-theme-bg-color);
            width: 100%;
        }

        .tg-btn {
            display: block;
            width: 100%;
            height: 50px;
            border-radius: 12px;
            border: none;
            background-color: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.1s ease, opacity 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .tg-btn:active {
            transform: scale(0.97);
            opacity: 0.9;
        }

        .tg-btn-secondary {
            background-color: transparent;
            color: var(--tg-theme-button-color);
            margin-top: 8px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #error-view, #loading-view {
            display: none;
            width: 100%;
            flex-direction: column;
            align-items: center;
        }

        .visible {
            display: flex !important;
        }
    </style>
</head>
<body>

    <div class="main-content">
        <div id="loading-view" class="visible">
            <div class="loader-wrapper">
                <div class="spinner"></div>
            </div>
            <div class="status-title">–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–¥–∞–Ω–∏—è...</div>
            <div class="status-sub" id="loading-text">–°–≤—è–∑—ã–≤–∞–µ–º—Å—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤</div>
        </div>

        <div id="error-view">
            <div class="error-icon">üòï</div>
            <div class="status-title" id="error-title">–£–ø—Å! –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞</div>
            <div class="status-sub" id="error-message">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.</div>
        </div>
    </div>

    <div class="footer-fixed" id="footer" style="display: none;">
        <button class="tg-btn" onclick="retryRedirect()">–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞</button>
    </div>

<script>
    const BACKEND_URL = 'https://app.92.114.54.237.nip.io/api';
    const tg = window.Telegram.WebApp;
    let isProcessing = false;
    let parsedParams = {};

    function initApp() {
        tg.ready();
        tg.expand();
        
        // –í–∫–ª—é—á–∞–µ–º –Ω–∞—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É "–ù–∞–∑–∞–¥", –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
        tg.BackButton.hide();

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ü–≤–µ—Ç–æ–≤ —Ç–µ–º—ã
        if (tg.setHeaderColor) tg.setHeaderColor(tg.themeParams.bg_color || '#ffffff');
    }

    function parseParams() {
        const startParam = tg.initDataUnsafe?.start_param || new URLSearchParams(window.location.search).get('startapp');
        
        if (!startParam) {
            showError('–ó–∞–¥–∞–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ', '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞');
            return null;
        }

        const parts = startParam.split('_');
        if (parts.length < 2) {
            showError('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Å—Å—ã–ª–∫–∞', '–§–æ—Ä–º–∞—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è —Å–∏—Å—Ç–µ–º–æ–π.');
            return null;
        }

        return {
            post_id: parseInt(parts[0]),
            admin_id: parseInt(parts[1]),
            ref: parts[2] || 'direct',
            platform: parts[3] || 'tg',
            raw: startParam
        };
    }

    async function processRedirect() {
        if (isProcessing) return;
        isProcessing = true;
        
        showLoading('–ü–µ—Ä–µ–∞–¥—Ä–µ—Å–∞—Ü–∏—è...', '–ì–æ—Ç–æ–≤–∏–º –¥–∏–∞–ª–æ–≥ —Å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º');

        try {
            const requestData = {
                startapp: parsedParams.raw,
                post_id: parsedParams.post_id,
                admin_id: parsedParams.admin_id,
                tg_user_id: tg.initDataUnsafe?.user?.id,
                ref: parsedParams.ref,
                platform: parsedParams.platform,
                source: 'mini_app',
                user_data: tg.initDataUnsafe?.user || {}
            };

            const response = await fetch(`${BACKEND_URL}/api/track`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestData)
            });

            const data = await response.json();

            if (!response.ok || !data.success) throw new Error(data.error || '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');

            // –£—Å–ø–µ—à–Ω–∞—è –ª–æ–≥–∏–∫–∞
            const username = data.username || 'shardtask_bot';
            const text = encodeURIComponent('–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, —è –∏–∑ –∫–∞–Ω–∞–ª–∞ SHARD –ø–æ –ø–æ–≤–æ–¥—É –∑–∞–¥–∞–Ω–∏—è!');
            const redirectUrl = `https://t.me/${username}?start=task_${parsedParams.post_id}`;

            tg.HapticFeedback.notificationOccurred('success');
            
            // –ü—ã—Ç–∞–µ–º—Å—è –æ—Ç–∫—Ä—ã—Ç—å —Å—Å—ã–ª–∫—É —á–µ—Ä–µ–∑ –Ω–∞—Ç–∏–≤–Ω—ã–π –º–µ—Ç–æ–¥ Telegram
            tg.openTelegramLink(redirectUrl);
            
            // –ï—Å–ª–∏ —á–µ—Ä–µ–∑ 2 —Å–µ–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –∑–∞–∫—Ä—ã–ª–æ—Å—å, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —Ä—É—á–Ω–æ–≥–æ –ø–µ—Ä–µ—Ö–æ–¥–∞
            setTimeout(() => {
                showError('–ü–æ—á—Ç–∏ –≥–æ—Ç–æ–≤–æ!', '–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, –µ—Å–ª–∏ –ø–µ—Ä–µ—Ö–æ–¥ –Ω–µ –ø—Ä–æ–∏–∑–æ—à–µ–ª –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.', false);
                document.querySelector('.tg-btn').textContent = '–ü–µ—Ä–µ–π—Ç–∏ –∫ –∞–¥–º–∏–Ω—É';
                document.querySelector('.tg-btn').onclick = () => tg.openTelegramLink(redirectUrl);
            }, 2000);

        } catch (e) {
            tg.HapticFeedback.notificationOccurred('error');
            showError('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è', '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≤—è–∑–∞—Ç—å—Å—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç.');
        } finally {
            isProcessing = false;
        }
    }

    function showLoading(title, sub) {
        document.getElementById('loading-view').classList.add('visible');
        document.getElementById('error-view').classList.remove('visible');
        document.getElementById('footer').style.display = 'none';
        if (title) document.querySelector('#loading-view .status-title').textContent = title;
        if (sub) document.getElementById('loading-text').textContent = sub;
    }

    function showError(title, msg, showBtn = true) {
        document.getElementById('loading-view').classList.remove('visible');
        document.getElementById('error-view').classList.add('visible');
        document.getElementById('error-title').textContent = title;
        document.getElementById('error-message').textContent = msg;
        document.getElementById('footer').style.display = showBtn ? 'block' : 'none';
    }

    function retryRedirect() {
        location.reload();
    }

    document.addEventListener('DOMContentLoaded', () => {
        initApp();
        parsedParams = parseParams();
        if (parsedParams) {
            setTimeout(processRedirect, 800);
        }
    });
</script>
</body>
</html>
