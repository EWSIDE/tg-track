<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TraffPost | Перенаправление...</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #ffffff;
            color: #000000;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .container {
            max-width: 400px;
            width: 100%;
            text-align: center;
        }
        
        .status-message {
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            font-size: 16px;
            background: rgba(51, 144, 236, 0.1);
            color: #3390ec;
            border: 1px solid rgba(51, 144, 236, 0.2);
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .loader {
            border: 3px solid rgba(51, 144, 236, 0.2);
            border-top: 3px solid #3390ec;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .debug-info {
            background: #f1f1f1;
            padding: 12px;
            border-radius: 12px;
            margin-top: 20px;
            font-size: 12px;
            color: #666;
            text-align: left;
            display: none; /* Скрыто по умолчанию */
            white-space: pre-wrap;
            word-break: break-all;
            font-family: monospace;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .error-message {
            background: rgba(220, 53, 69, 0.1);
            color: #dc3545;
            border: 1px solid rgba(220, 53, 69, 0.2);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="status-message" id="status-message">
            <div class="loader"></div>
            <div>Отслеживаю клик и перенаправляю...</div>
        </div>
        
        <div class="error-message" id="error-message" style="display: none;"></div>
        
        <div class="debug-info" id="debug-info">
            <strong>Отладочная информация:</strong><br>
            <div id="debug-content">Загрузка данных...</div>
        </div>
    </div>

    <script>
        // ============================================
        // КОНФИГУРАЦИЯ БЭКЕНДА
        // ============================================
        
        const BACKEND_URL = 'https://5-129-200-89.nip.io';
        const API_ENDPOINTS = {
            apiTrack: `${BACKEND_URL}/api/track`
        };
        
        // ============================================
        // ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ
        // ============================================
        
        const tg = window.Telegram.WebApp;
        let postId = null;
        let adminId = null;
        let ref = null;
        let platform = 'tg';
        let tgUserId = null;
        let tgUser = null;
        let parsedParams = {};
        let hasProcessed = false;
        
        // ============================================
        // ФУНКЦИИ ДЛЯ РАБОТЫ С ТЕЛЕГРАМ
        // ============================================
        
        function initTelegram() {
            try {
                tg.ready();
                tg.expand();
                
                // Получаем данные пользователя
                if (tg.initDataUnsafe?.user) {
                    tgUser = tg.initDataUnsafe.user;
                    tgUserId = tgUser.id.toString();
                    console.log("Telegram user data:", tgUser);
                } else {
                    console.warn("No Telegram user data available");
                }
                
                return true;
            } catch (error) {
                console.error("Ошибка инициализации Telegram:", error);
                return false;
            }
        }
        
        // ============================================
        // ПАРСИНГ ПАРАМЕТРОВ
        // ============================================
        
        function parseTelegramParams() {
            console.log("=== ПАРСИНГ ПАРАМЕТРОВ ===");
            
            let startParam = null;
            
            // 1. Пробуем получить параметр из Telegram
            if (tg.initDataUnsafe?.tgWebAppStartParam) {
                startParam = tg.initDataUnsafe.tgWebAppStartParam;
                console.log("Параметр из tgWebAppStartParam:", startParam);
            } else if (tg.initDataUnsafe?.start_param) {
                startParam = tg.initDataUnsafe.start_param;
                console.log("Параметр из start_param:", startParam);
            }
            
            // 2. Пробуем получить из URL (для тестирования)
            if (!startParam) {
                const urlParams = new URLSearchParams(window.location.search);
                const testParam = urlParams.get('test');
                const startapp = urlParams.get('startapp');
                
                if (testParam) {
                    startParam = testParam;
                    console.log("Параметр из URL (test):", startParam);
                } else if (startapp) {
                    startParam = startapp;
                    console.log("Параметр из URL (startapp):", startParam);
                }
            }
            
            if (!startParam) {
                console.warn("Параметры не найдены!");
                showError('Ошибка: Не указаны параметры задания');
                return null;
            }
            
            // Очищаем параметр
            let cleanParam = startParam;
            if (cleanParam.startsWith('?')) cleanParam = cleanParam.substring(1);
            if (cleanParam.includes('tgWebAppStartParam=')) {
                cleanParam = cleanParam.split('tgWebAppStartParam=')[1];
            }
            
            console.log("Очищенный параметр:", cleanParam);
            
            // Парсим формат: postid_adminid_ref_platform
            const parts = cleanParam.split('_');
            
            if (parts.length >= 2) {
                try {
                    postId = parseInt(parts[0]);
                    adminId = parseInt(parts[1]);
                    ref = parts.length > 2 ? parts[2] : null;
                    platform = parts.length > 3 ? parts[3] : 'tg';
                    
                    parsedParams = {
                        post_id: postId,
                        admin_id: adminId,
                        ref: ref,
                        platform: platform,
                        raw_param: cleanParam,
                        parsed_successfully: true
                    };
                    
                    console.log("Успешно распарсено:", parsedParams);
                    return parsedParams;
                    
                } catch (error) {
                    console.error("Ошибка парсинга:", error);
                    showError('Ошибка: Неверный формат параметров');
                    return null;
                }
            } else {
                console.warn("Неверный формат параметра");
                showError('Ошибка: Неверный формат параметров');
                return null;
            }
        }
        
        // ============================================
        // ОСНОВНАЯ ФУНКЦИЯ ОБРАБОТКИ И РЕДИРЕКТА
        // ============================================
        
        async function processAndRedirect() {
            if (hasProcessed) return;
            hasProcessed = true;
            
            const statusMessage = document.getElementById('status-message');
            statusMessage.innerHTML = `
                <div class="loader"></div>
                <div>Отслеживаю клик...</div>
            `;
            
            try {
                console.log("Отправка данных на бэкенд для отслеживания...");
                
                // Подготавливаем данные для отправки
                const requestData = {
                    startapp: parsedParams.raw_param,
                    post_id: parsedParams.post_id,
                    admin_id: parsedParams.admin_id,
                    tg_user_id: tgUserId,
                    ref: parsedParams.ref || 'direct',
                    platform: parsedParams.platform,
                    source: 'mini_app',
                    timestamp: new Date().toISOString()
                };
                
                // Добавляем данные пользователя
                if (tgUser) {
                    requestData.user_data = {
                        id: tgUser.id,
                        username: tgUser.username,
                        first_name: tgUser.first_name,
                        last_name: tgUser.last_name,
                        language_code: tgUser.language_code,
                        is_premium: tgUser.is_premium || false
                    };
                }
                
                console.log("Данные запроса:", requestData);
                
                // Отправляем запрос на бэкенд для отслеживания
                const response = await fetch(API_ENDPOINTS.apiTrack, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });
                
                console.log("Статус ответа от бэкенда:", response.status);
                
                let data;
                try {
                    data = await response.json();
                    console.log("Ответ от бэкенда:", data);
                } catch (jsonError) {
                    console.error("Ошибка парсинга JSON:", jsonError);
                    throw new Error('Ошибка формата ответа от сервера');
                }
                
                if (!response.ok) {
                    throw new Error(data.error || `HTTP error! status: ${response.status}`);
                }
                
                // Обновляем статус
                let message = '';
                if (data.success) {
                    if (data.click_counted && data.is_unique) {
                        message = '✅ Уникальный клик засчитан. Перенаправляю...';
                    } else if (data.click_counted && !data.is_unique) {
                        message = '⚠️ Повторный клик. Перенаправляю...';
                    } else {
                        message = 'Отслеживание завершено. Перенаправляю...';
                    }
                } else {
                    message = 'Завершаю обработку. Перенаправляю...';
                }
                
                statusMessage.innerHTML = `
                    <div style="margin-bottom: 10px;">✓</div>
                    <div>${message}</div>
                `;
                
                // Выполняем редирект через 1 секунду
                setTimeout(() => {
                    const username = data.admin_username?.replace('@', '');
                    const preText = "Здравствуйте, я с канала SHARD по поводу задания!";
                    
                    if (username && username !== 'undefined' && username !== 'null') {
                        const url = `https://t.me/${username}?text=${encodeURIComponent(preText)}`;
                        console.log("Редирект на:", url);
                        tg.openTelegramLink(url);
                    } else {
                        // Если username не найден, пробуем редирект на бота
                        const fallbackUrl = `tg://resolve?domain=shardlightspace_bot`;
                        console.log("Редирект на fallback:", fallbackUrl);
                        tg.openTelegramLink(fallbackUrl);
                    }
                }, 1000);
                
            } catch (error) {
                console.error("Ошибка при отправке запроса:", error);
                
                // Даже при ошибке пробуем выполнить редирект
                statusMessage.innerHTML = `
                    <div style="margin-bottom: 10px;">⚠️</div>
                    <div>Ошибка соединения. Перенаправляю...</div>
                `;
                
                // Редирект при ошибке через 2 секунды
                setTimeout(() => {
                    const preText = "Здравствуйте, я с канала SHARD по поводу задания!";
                    const fallbackUrl = `tg://resolve?domain=shardlightspace_bot`;
                    console.log("Редирект при ошибке на:", fallbackUrl);
                    tg.openTelegramLink(fallbackUrl);
                }, 2000);
            }
        }
        
        // ============================================
        // ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ
        // ============================================
        
        function showError(message) {
            const errorElement = document.getElementById('error-message');
            errorElement.textContent = message;
            errorElement.style.display = 'block';
            
            const statusMessage = document.getElementById('status-message');
            statusMessage.style.display = 'none';
        }
        
        function updateDebugInfo() {
            const debugContent = document.getElementById('debug-content');
            
            const debugData = {
                "Backend URL": BACKEND_URL,
                "Post ID": postId,
                "Admin ID": adminId,
                "Ref": ref,
                "Platform": platform,
                "User ID": tgUserId,
                "Username": tgUser?.username || 'Нет',
                "Telegram Platform": tg.platform,
                "Parsed Params": parsedParams
            };
            
            debugContent.innerHTML = Object.entries(debugData)
                .map(([key, value]) => {
                    const formattedValue = typeof value === 'object' 
                        ? JSON.stringify(value, null, 2) 
                        : String(value);
                    return `<strong>${key}:</strong> ${formattedValue}`;
                })
                .join('<br>');
        }
        
        // ============================================
        // ИНИЦИАЛИЗАЦИЯ ПРИЛОЖЕНИЯ
        // ============================================
        
        document.addEventListener('DOMContentLoaded', async function() {
            console.log("=== ИНИЦИАЛИЗАЦИЯ TRAFFPOST ===");
            
            try {
                // 1. Инициализируем Telegram
                const telegramReady = initTelegram();
                if (!telegramReady) {
                    showError('Ошибка инициализации Telegram');
                    return;
                }
                
                // 2. Парсим параметры
                parsedParams = parseTelegramParams();
                
                if (!parsedParams || !parsedParams.parsed_successfully) {
                    return;
                }
                
                // 3. Обновляем отладочную информацию
                updateDebugInfo();
                
                // 4. Запускаем обработку и редирект через 500мс
                setTimeout(() => {
                    processAndRedirect();
                }, 500);
                
                console.log("Приложение инициализировано, запущен автоматический редирект");
                
            } catch (error) {
                console.error("Критическая ошибка при инициализации:", error);
                showError('Критическая ошибка при загрузке');
                
                // Пробуем редирект даже при критической ошибке
                setTimeout(() => {
                    const preText = "Здравствуйте, я с канала SHARD по поводу задания!";
                    const fallbackUrl = `tg://resolve?domain=shardlightspace_bot`;
                    tg.openTelegramLink(fallbackUrl);
                }, 3000);
            }
        });
    </script>
</body>
</html>
