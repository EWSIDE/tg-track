<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0, viewport-fit=cover"
  />
  <title>Task Flow</title>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root {
      --bg: #000000;
      --text: #ffffff;
      --muted: rgba(255, 255, 255, 0.45);
      --line: rgba(255, 255, 255, 0.14);

      --safe-top: env(safe-area-inset-top);
      --safe-bottom: env(safe-area-inset-bottom);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      background: #000;
      color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Segoe UI", Roboto, sans-serif;
      min-height: 100vh;
      padding-top: calc(28px + var(--safe-top));
      padding-bottom: calc(20px + var(--safe-bottom));
    }

    .app {
      max-width: 420px;
      margin: 0 auto;
      padding: 0 18px;
    }

    .stepper {
      display: flex;
      flex-direction: column;
      gap: 28px;
      margin-top: 12px;
    }

    .step {
      display: flex;
      gap: 18px;
      align-items: flex-start;
      animation: springIn 0.5s cubic-bezier(0.22, 1, 0.36, 1) both;
    }

    .step-rail {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .step-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--muted);
      position: relative;
    }

    .step-line {
      width: 2px;
      height: 38px;
      background: var(--line);
      margin-top: 8px;
      border-radius: 2px;
    }

    .step-title {
      font-size: 15px;
      line-height: 1.45;
      letter-spacing: -0.01em;
      color: var(--muted);
      transition: color 0.3s ease;
    }

    .step.done .step-dot {
      background: #fff;
    }

    .step.active .step-dot {
      background: #fff;
    }

    .step.active .step-dot::after {
      content: "";
      position: absolute;
      inset: -8px;
      border-radius: 50%;
      border: 1px solid rgba(255, 255, 255, 0.35);
      animation: pulse 1.6s ease-out infinite;
    }

    .step.done .step-title,
    .step.active .step-title {
      color: #fff;
    }

    @keyframes springIn {
      from {
        opacity: 0;
        transform: translateY(14px) scale(0.98);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    @keyframes pulse {
      0% {
        opacity: 0.9;
        transform: scale(0.6);
      }
      100% {
        opacity: 0;
        transform: scale(1.4);
      }
    }
  </style>
</head>

<body>
  <div class="app">
    <div id="stepper" class="stepper"></div>
  </div>

  <script>
    /**********************************************************
     * CONFIG
     **********************************************************/
    const BACKEND_URL = "https://5-129-200-89.nip.io";
    const API_TRACK = BACKEND_URL + "/api/track";
    const tg = window.Telegram.WebApp;

    let parsedParams = null;
    let tgUser = null;

    /**********************************************************
     * STEPS
     **********************************************************/
    const STEPS = [
      "Загрузка задания",
      "Проверка пользователя",
      "Фиксация отклика",
      "Переадресация"
    ];

    function renderStepper(activeIndex) {
      const root = document.getElementById("stepper");
      root.innerHTML = "";

      STEPS.forEach((title, index) => {
        let state = "pending";
        if (index < activeIndex) state = "done";
        if (index === activeIndex) state = "active";

        const el = document.createElement("div");
        el.className = `step ${state}`;
        el.style.animationDelay = `${index * 60}ms`;

        el.innerHTML = `
          <div class="step-rail">
            <div class="step-dot"></div>
            ${index < STEPS.length - 1 ? `<div class="step-line"></div>` : ""}
          </div>
          <div class="step-title">${title}</div>
        `;

        root.appendChild(el);
      });
    }

    /**********************************************************
     * TELEGRAM INIT
     **********************************************************/
    function initTelegram() {
      tg.ready();
      tg.expand();
      tg.setBackgroundColor("#000000");
      tg.setHeaderColor("#000000");

      tg.MainButton.setParams({
        text: "Закрыть",
        is_visible: true
      });

      tg.MainButton.onClick(() => tg.close());

      if (tg.initDataUnsafe?.user) {
        tgUser = tg.initDataUnsafe.user;
      }
    }

    function parseParams() {
      let start =
        tg.initDataUnsafe?.tgWebAppStartParam ||
        tg.initDataUnsafe?.start_param;

      if (!start) {
        start = new URLSearchParams(location.search).get("test");
      }

      if (!start) return null;

      const p = start.replace("tgWebAppStartParam=", "").split("_");
      return {
        raw: start,
        post_id: +p[0],
        admin_id: +p[1],
        ref: p[2] || "direct",
        platform: p[3] || "tg"
      };
    }

    /**********************************************************
     * FLOW
     **********************************************************/
    async function autoFlow() {
      renderStepper(0);
      await delay(400);

      renderStepper(1);
      await delay(400);

      renderStepper(2);

      const payload = {
        startapp: parsedParams.raw,
        post_id: parsedParams.post_id,
        admin_id: parsedParams.admin_id,
        tg_user_id: tgUser?.id?.toString(),
        ref: parsedParams.ref,
        platform: parsedParams.platform,
        source: "mini_app",
        timestamp: new Date().toISOString(),
        user_data: tgUser || null
      };

      const res = await fetch(API_TRACK, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      const data = await res.json();
      if (!data?.success) return;

      renderStepper(3);

      const username = data.admin_username?.replace("@", "");
      const text = `Здравствуйте! Я по поводу задания на ${parsedParams.platform}`;
      const url = `https://t.me/${username}?text=${encodeURIComponent(text)}`;

      tg.openTelegramLink(url);
    }

    const delay = (ms) => new Promise((r) => setTimeout(r, ms));

    /**********************************************************
     * BOOT
     **********************************************************/
    document.addEventListener("DOMContentLoaded", () => {
      initTelegram();
      parsedParams = parseParams();
      renderStepper(0);
      if (parsedParams) autoFlow();
    });
  </script>
</body>
</html>
