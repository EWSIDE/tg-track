<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TraffPost | Задание</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: #000000;
            color: #ffffff;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        .container {
            position: relative;
            width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .cloud {
            position: absolute;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            filter: blur(50px);
            opacity: 0.6;
            animation: float 6s infinite ease-in-out;
        }
        
        .cloud-1 {
            width: 250px;
            height: 120px;
            top: 20%;
            left: 10%;
            animation-delay: 0s;
        }
        
        .cloud-2 {
            width: 180px;
            height: 90px;
            top: 60%;
            right: 15%;
            animation-delay: 2s;
            background: linear-gradient(135deg, #764ba2 0%, #3390ec 100%);
        }
        
        .cloud-3 {
            width: 200px;
            height: 100px;
            bottom: 20%;
            left: 20%;
            animation-delay: 4s;
            background: linear-gradient(135deg, #3390ec 0%, #764ba2 100%);
        }
        
        .text {
            position: relative;
            z-index: 2;
            text-align: center;
            padding: 20px;
        }
        
        .loading {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 10px;
            animation: pulse 1.5s infinite;
        }
        
        .subtext {
            font-size: 14px;
            opacity: 0.8;
        }
        
        @keyframes float {
            0%, 100% {
                transform: translateY(0) scale(1);
                opacity: 0.4;
            }
            50% {
                transform: translateY(-20px) scale(1.05);
                opacity: 0.7;
            }
        }
        
        @keyframes pulse {
            0%, 100% {
                opacity: 0.8;
            }
            50% {
                opacity: 1;
            }
        }
        
        .counter {
            position: absolute;
            bottom: 30px;
            font-size: 12px;
            opacity: 0.6;
        }
        
        .success-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            opacity: 0;
            animation: fadeIn 0.5s forwards 0.5s;
        }
        
        @keyframes fadeIn {
            to {
                opacity: 1;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="cloud cloud-1"></div>
        <div class="cloud cloud-2"></div>
        <div class="cloud cloud-3"></div>
        
        <div class="text">
            <div class="loading" id="loadingText">Подключение...</div>
            <div class="subtext" id="subtext">TraffPost v2.0</div>
        </div>
        
        <div class="counter" id="counter"></div>
        
        <div class="success-message" id="successMessage" style="display: none;">
            <div style="font-size: 20px; margin-bottom: 10px;">✓ Перенаправление выполнено</div>
            <div style="font-size: 14px; opacity: 0.7;">Мини-приложение можно закрыть</div>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        let isRedirecting = false;
        
        // Инициализация Telegram
        tg.ready();
        tg.expand();
        
        // Устанавливаем черный фон
        tg.setHeaderColor('#000000');
        tg.setBackgroundColor('#000000');
        
        // Основная функция для переадресации
        function redirectToAdmin(adminUsername, platform) {
            if (isRedirecting) return;
            isRedirecting = true;
            
            // Убираем hover эффект перед закрытием
            document.body.style.pointerEvents = 'none';
            
            // Фиксированное сообщение
            const message = 'Здравствуйте, я с канала SHARD по поводу задания!';
            
            if (!adminUsername || adminUsername === 'undefined' || adminUsername === 'null') {
                console.log("Нет username, используем бота");
                showSuccessMessage();
                setTimeout(() => {
                    tg.openTelegramLink(`https://t.me/shardlightspace_bot?text=${encodeURIComponent(message)}`);
                }, 1000);
                return;
            }
            
            // Очищаем username
            const cleanUsername = adminUsername.replace('@', '');
            
            // Формируем ссылку для открытия чата с фиксированным сообщением
            const telegramUrl = `https://t.me/${cleanUsername}?text=${encodeURIComponent(message)}`;
            
            console.log("Переход по ссылке:", telegramUrl);
            
            // Показываем сообщение об успехе перед редиректом
            showSuccessMessage();
            
            // Задержка для стабильности работы WebApp
            setTimeout(() => {
                try {
                    // Основной способ с безопасным закрытием WebApp
                    tg.openTelegramLink(telegramUrl);
                    
                    // Дополнительная задержка перед попыткой скрытия WebApp
                    setTimeout(() => {
                        try {
                            if (tg.isClosingConfirmationEnabled) {
                                tg.disableClosingConfirmation();
                            }
                            tg.close();
                        } catch (e) {
                            console.log("Не удалось закрыть WebApp автоматически");
                        }
                    }, 500);
                    
                } catch (error) {
                    console.error("Ошибка при openTelegramLink:", error);
                    
                    // Альтернативный способ с задержкой
                    setTimeout(() => {
                        try {
                            window.location.href = telegramUrl;
                        } catch (e) {
                            console.error("Ошибка при window.location:", e);
                            
                            // Финальный fallback с новым окном
                            setTimeout(() => {
                                window.open(telegramUrl, '_blank');
                            }, 300);
                        }
                    }, 300);
                }
            }, 1000);
        }
        
        // Функция для показа сообщения об успешной переадресации
        function showSuccessMessage() {
            const text = document.querySelector('.text');
            const successMessage = document.getElementById('successMessage');
            
            if (text) text.style.opacity = '0.3';
            if (successMessage) successMessage.style.display = 'block';
        }
        
        // Функция для отправки данных на бэкенд
        async function trackAndRedirect() {
            const loadingText = document.getElementById('loadingText');
            const subtext = document.getElementById('subtext');
            const counter = document.getElementById('counter');
            
            try {
                // 1. Получаем параметры
                let startParam = tg.initDataUnsafe?.tgWebAppStartParam || 
                                tg.initDataUnsafe?.start_param;
                
                // Если нет параметров в Telegram, проверяем URL
                if (!startParam) {
                    const urlParams = new URLSearchParams(window.location.search);
                    startParam = urlParams.get('startapp') || urlParams.get('test');
                }
                
                if (!startParam) {
                    loadingText.textContent = "Ошибка: нет параметров";
                    subtext.textContent = "Переадресация через 3 секунды...";
                    
                    setTimeout(() => {
                        redirectToAdmin(null, 'tg');
                    }, 3000);
                    return;
                }
                
                // 2. Парсим параметры
                console.log("Start param:", startParam);
                
                // Очищаем параметр
                let cleanParam = startParam;
                if (cleanParam.startsWith('?')) cleanParam = cleanParam.substring(1);
                
                const parts = cleanParam.split('_');
                if (parts.length < 2) {
                    throw new Error("Неверный формат параметров");
                }
                
                const postId = parseInt(parts[0]);
                const adminId = parseInt(parts[1]);
                const platform = parts.length > 3 ? parts[3] : 'tg';
                const ref = parts.length > 2 ? parts[2] : null;
                
                loadingText.textContent = "Отправка данных...";
                subtext.textContent = `Задание #${postId}`;
                
                // 3. Подготавливаем данные пользователя
                let userData = {};
                if (tg.initDataUnsafe?.user) {
                    const user = tg.initDataUnsafe.user;
                    userData = {
                        id: user.id,
                        username: user.username,
                        first_name: user.first_name,
                        last_name: user.last_name,
                        language_code: user.language_code,
                        is_premium: user.is_premium || false
                    };
                }
                
                // 4. Формируем запрос
                const requestData = {
                    startapp: cleanParam,
                    post_id: postId,
                    admin_id: adminId,
                    tg_user_id: userData.id || null,
                    ref: ref || 'direct',
                    platform: platform,
                    source: 'mini_app',
                    timestamp: new Date().toISOString(),
                    user_data: userData
                };
                
                // 5. Отправляем запрос на бэкенд
                loadingText.textContent = "Обработка...";
                
                const response = await fetch('https://5-129-200-89.nip.io/api/track', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData),
                    mode: 'cors',
                    credentials: 'omit'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log("Ответ бэкенда:", data);
                
                // 6. Обрабатываем ответ
                if (data.success) {
                    loadingText.textContent = data.is_unique ? "Успешно!" : "✓ Обработка...";
                    subtext.textContent = data.is_unique ? "Клик засчитан" : "Переадресация";
                    
                    // Немедленная переадресация с задержкой для стабильности
                    setTimeout(() => {
                        redirectToAdmin(data.admin_username, platform);
                    }, 800);
                    
                    // Таймер обратного отсчета
                    let count = 3;
                    const countdown = setInterval(() => {
                        counter.textContent = `Переход через ${count} сек...`;
                        count--;
                        if (count < 0) {
                            clearInterval(countdown);
                        }
                    }, 1000);
                    
                } else {
                    throw new Error(data.error || "Ошибка сервера");
                }
                
            } catch (error) {
                console.error("Ошибка:", error);
                
                loadingText.textContent = "Ошибка подключения";
                subtext.textContent = "Прямая переадресация...";
                
                // В любом случае переадресовываем с задержкой
                setTimeout(() => {
                    redirectToAdmin(null, 'tg');
                }, 2000);
                
                // Таймер обратного отсчета
                let count = 2;
                const countdown = setInterval(() => {
                    counter.textContent = `Переход через ${count} сек...`;
                    count--;
                    if (count < 0) {
                        clearInterval(countdown);
                    }
                }, 1000);
            }
        }
        
        // Запускаем при загрузке
        document.addEventListener('DOMContentLoaded', () => {
            // Настройка WebApp для стабильной работы
            if (tg.isClosingConfirmationEnabled) {
                tg.disableClosingConfirmation();
            }
            
            // Небольшая задержка для показа анимации
            setTimeout(() => {
                trackAndRedirect();
            }, 500);
        });
        
        // Обработчик для случаев, когда пользователь возвращается в мини-приложение
        window.addEventListener('focus', () => {
            if (isRedirecting) {
                // Показываем финальное сообщение
                showSuccessMessage();
                
                // Предлагаем закрыть приложение
                setTimeout(() => {
                    try {
                        tg.close();
                    } catch (e) {
                        console.log("WebApp уже закрыт");
                    }
                }, 1000);
            }
        });
    </script>
</body>
</html>
