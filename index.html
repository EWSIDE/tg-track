<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Отклик</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root{
      --bg1:#0b1324;
      --bg2:#0a1f3b;
      --glass: rgba(0,0,0,.55);
      --glass2: rgba(255,255,255,.06);
      --stroke: rgba(255,255,255,.10);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.62);
      --muted2: rgba(255,255,255,.46);
      --blue:#2a5cff;
      --blue2:#00d1ff;
      --red: rgba(255, 120, 120, .95);
    }

    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    body{
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "SF Pro Text", Segoe UI, Roboto, Arial, sans-serif;
      background: #000;
      overflow:hidden;
    }

    /* FULLSCREEN */
    #overlay{
      position:fixed; inset:0;
      padding:
        max(16px, env(safe-area-inset-top))
        max(16px, env(safe-area-inset-right))
        max(16px, env(safe-area-inset-bottom))
        max(16px, env(safe-area-inset-left));
      display:flex; align-items:center; justify-content:center;
      background:
        radial-gradient(900px 700px at 20% 10%, rgba(42,92,255,.25), transparent 60%),
        radial-gradient(900px 650px at 85% 30%, rgba(0,209,255,.14), transparent 55%),
        linear-gradient(135deg, var(--bg1), var(--bg2));
      transition: opacity .28s ease;
      opacity:1;
    }

    /* iOS glass card */
    .card{
      width: min(520px, 100%);
      border-radius: 26px;
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      border: 1px solid var(--stroke);
      box-shadow: 0 26px 90px rgba(0,0,0,.65);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      padding: 18px 18px 16px;
      position: relative;
      overflow:hidden;
    }

    .card::before{
      content:"";
      position:absolute;
      inset:-120px -160px auto auto;
      width: 320px; height: 320px;
      background: radial-gradient(circle at 30% 30%, rgba(42,92,255,.32), transparent 62%);
      transform: rotate(18deg);
      pointer-events:none;
    }

    .top{
      display:flex; align-items:center; justify-content:space-between;
      gap: 12px;
      margin-bottom: 14px;
    }
    .title{
      font-size: 17px;
      font-weight: 700;
      color: var(--text);
      letter-spacing: .2px;
    }
    .icons{display:flex; align-items:center; gap:8px; opacity:.95}
    .pill{
      width: 30px; height: 30px;
      border-radius: 999px;
      background: rgba(42,92,255,.16);
      border: 1px solid rgba(42,92,255,.30);
      display:grid; place-items:center;
    }
    .pill svg{width:16px;height:16px;opacity:.92;fill:rgba(255,255,255,.90)}

    /* progress line like iOS */
    .steps{
      display:flex; align-items:center;
      gap: 10px;
      padding: 8px 2px 10px;
      margin-bottom: 10px;
    }
    .dot{
      width: 18px; height: 18px;
      border-radius: 999px;
      border: 2px solid rgba(42,92,255,.65);
      opacity:.30;
      flex:0 0 auto;
      position:relative;
      background: transparent;
    }
    .dot.done{
      opacity:1;
      background: rgba(42,92,255,1);
      border-color: rgba(42,92,255,1);
    }
    .dot.done::after{
      content:"";
      position:absolute; inset:0;
      margin:auto;
      width: 8px; height: 8px;
      border-radius:999px;
      background: rgba(8,18,40,.95);
    }
    .dot.active{
      opacity:1;
      background: rgba(42,92,255,1);
      border-color: rgba(42,92,255,1);
      box-shadow: 0 0 0 0 rgba(42,92,255,.45);
      animation: pulse 1.2s infinite ease-in-out;
    }

    .bar{
      flex:1;
      height: 4px;
      border-radius: 999px;
      background: rgba(42,92,255,.18);
      position:relative;
      overflow:hidden;
    }
    .bar.flow::before{
      content:"";
      position:absolute; inset:0;
      background: rgba(42,92,255,.78);
      transform: translateX(-100%);
      animation: flow 1.1s linear infinite;
    }

    @keyframes pulse{
      0%{transform:scale(1); box-shadow:0 0 0 0 rgba(42,92,255,.45)}
      60%{transform:scale(1.06); box-shadow:0 0 0 16px rgba(42,92,255,0)}
      100%{transform:scale(1); box-shadow:0 0 0 0 rgba(42,92,255,0)}
    }
    @keyframes flow{
      0%{transform:translateX(-100%)}
      100%{transform:translateX(100%)}
    }

    .bottom{
      display:flex; align-items:baseline; justify-content:space-between;
      gap: 10px;
    }
    .text{
      font-size: 15px;
      color: var(--text);
      line-height: 1.2;
    }
    .count{
      font-size: 13px;
      color: var(--muted2);
      white-space:nowrap;
    }
    .sub{
      margin-top: 10px;
      font-size: 12px;
      color: var(--muted);
      line-height: 1.35;
    }
    .error{
      display:none;
      margin-top: 10px;
      font-size: 13px;
      color: var(--red);
      line-height: 1.35;
    }

    /* hidden legacy */
    #legacy { display:none; }
  </style>
</head>

<body>
  <div id="overlay">
    <div class="card">
      <div class="top">
        <div class="title">Отклик</div>
        <div class="icons" aria-hidden="true">
          <div class="pill">
            <svg viewBox="0 0 24 24"><path d="M20 4H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2Zm0 4-8 5-8-5V6l8 5 8-5v2Z"/></svg>
          </div>
          <div class="pill">
            <svg viewBox="0 0 24 24"><path d="M12 3C7.03 3 3 6.58 3 11c0 2.38 1.18 4.52 3.07 6.03L5 21l4.29-2.29c.85.19 1.76.29 2.71.29 4.97 0 9-3.58 9-8s-4.03-8-9-8Z"/></svg>
          </div>
          <div class="pill">
            <svg viewBox="0 0 24 24"><path d="M6 2h9l3 3v17a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2Zm8 1.5V6h2.5L14 3.5ZM7 9h8v2H7V9Zm0 4h8v2H7v-2Zm0 4h6v2H7v-2Z"/></svg>
          </div>
        </div>
      </div>

      <div class="steps" id="steps"></div>

      <div class="bottom">
        <div class="text" id="pText">Инициализация…</div>
        <div class="count" id="pCount">1 из 5</div>
      </div>

      <div class="sub" id="pSub">Пожалуйста, не закрывайте окно — идёт обработка.</div>
      <div class="error" id="pError"></div>
    </div>
  </div>

  <!-- ТЕХНИЧЕСКИЕ ЭЛЕМЕНТЫ ДЛЯ СОВМЕСТИМОСТИ (без старых стилей) -->
  <div id="legacy">
    <button id="track-button" onclick="handleClick()" disabled>Откликнуться</button>
    <div id="loading"></div>
    <div id="status-message"></div>
    <div id="task-status"></div>
    <div id="initial-status"></div>
    <div id="task-info"></div>
    <div id="post-id"></div>
    <div id="admin-info"></div>
    <div id="user-id"></div>
    <div id="subtitle"></div>
    <div id="page-title"></div>
    <div id="debug-content"></div>
  </div>

  <script>
    // ============================================
    // КОНФИГУРАЦИЯ БЭКЕНДА
    // ============================================
    const BACKEND_URL = 'https://5-129-200-89.nip.io';
    const API_ENDPOINTS = {
      apiTrack: `${BACKEND_URL}/api/track`,
      health: `${BACKEND_URL}/health`
    };

    // ============================================
    // ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ
    // ============================================
    const tg = window.Telegram.WebApp;
    let postId = null;
    let adminId = null;
    let ref = null;
    let platform = 'tg';
    let tgUserId = null;
    let tgUser = null;
    let parsedParams = {};
    let hasClicked = false;

    // ============================================
    // ПРОГРЕСС UI
    // ============================================
    const TOTAL = 5;

    function buildSteps() {
      const el = document.getElementById('steps');
      el.innerHTML = '';
      for (let i = 1; i <= TOTAL; i++) {
        const dot = document.createElement('div');
        dot.className = 'dot';
        dot.dataset.step = String(i);
        el.appendChild(dot);

        if (i !== TOTAL) {
          const bar = document.createElement('div');
          bar.className = 'bar';
          el.appendChild(bar);
        }
      }
    }

    function setProgress(step, text, subText) {
      const s = Math.max(1, Math.min(step, TOTAL));
      document.getElementById('pText').textContent = text || '…';
      document.getElementById('pCount').textContent = `${s} из ${TOTAL}`;
      if (typeof subText === 'string') document.getElementById('pSub').textContent = subText;

      const kids = Array.from(document.getElementById('steps').children);
      let idx = 1;

      for (const k of kids) {
        if (k.classList.contains('dot')) {
          k.classList.remove('done', 'active');
          if (idx < s) k.classList.add('done');
          else if (idx === s) k.classList.add('active');
          idx++;
        } else if (k.classList.contains('bar')) {
          k.classList.remove('flow');
          // flow на баре после активного шага
          const before = idx - 1;
          if (before === s) k.classList.add('flow');
        }
      }
    }

    function showError(msg) {
      const e = document.getElementById('pError');
      e.textContent = msg;
      e.style.display = 'block';
    }

    function fadeOut() {
      const o = document.getElementById('overlay');
      o.style.opacity = '0';
      setTimeout(() => { o.style.display = 'none'; }, 300);
    }

    // ============================================
    // Telegram init
    // ============================================
    function initTelegram() {
      try {
        tg.ready();
        tg.expand();
        tg.enableClosingConfirmation();

        if (tg.initDataUnsafe?.user) {
          tgUser = tg.initDataUnsafe.user;
          tgUserId = String(tgUser.id);
        }
        return true;
      } catch (e) {
        console.error(e);
        return false;
      }
    }

    // ============================================
    // params parse
    // ============================================
    function parseTelegramParams() {
      let startParam = tg.initDataUnsafe?.tgWebAppStartParam || tg.initDataUnsafe?.start_param || null;

      if (!startParam) {
        const urlParams = new URLSearchParams(window.location.search);
        startParam = urlParams.get('test') || urlParams.get('startapp');
      }

      if (!startParam) {
        showError('Ошибка: не переданы параметры задания.');
        return null;
      }

      let clean = startParam;
      if (clean.startsWith('?')) clean = clean.substring(1);
      if (clean.includes('tgWebAppStartParam=')) clean = clean.split('tgWebAppStartParam=')[1];

      const parts = clean.split('_');
      if (parts.length < 2) {
        showError('Ошибка: неверный формат параметров.');
        return { parsed_successfully: false };
      }

      try {
        postId = parseInt(parts[0], 10);
        adminId = parseInt(parts[1], 10);
        ref = parts.length > 2 ? parts[2] : null;
        platform = parts.length > 3 ? parts[3] : 'tg';

        return {
          post_id: postId,
          admin_id: adminId,
          ref,
          platform,
          raw_param: clean,
          parsed_successfully: true
        };
      } catch (e) {
        showError('Ошибка: параметры не читаются.');
        return { parsed_successfully: false };
      }
    }

    // ============================================
    // redirect helper (FIXED)
    // ============================================
    function openRedirectFromData(data) {
      // 1) Самое надёжное — прямая ссылка от бэка
      if (data?.redirect_url && typeof data.redirect_url === 'string' && data.redirect_url.trim()) {
        fadeOut();
        tg.openTelegramLink(data.redirect_url);
        return true;
      }

      // 2) Если есть username — соберём ссылку сами
      const username = (data?.admin_username || '').toString().replace('@', '').trim();
      if (username) {
        const text = `Здравствуйте! Я по поводу задания (${platform}).`;
        const url = `https://t.me/${username}?text=${encodeURIComponent(text)}`;
        fadeOut();
        tg.openTelegramLink(url);
        return true;
      }

      // 3) Фолбэк
      fadeOut();
      tg.openTelegramLink('tg://resolve?domain=shardlightspace_bot');
      return false;
    }

    // ============================================
    // MAIN (логика твоя, визуал новый)
    // ============================================
    async function handleClick() {
      if (hasClicked) return;
      if (!parsedParams || !parsedParams.parsed_successfully) {
        showError('Ошибка: нет данных задания.');
        return;
      }
      hasClicked = true;

      try {
        setProgress(3, 'Отправляем отклик…', 'Связываемся с сервером…');

        const requestData = {
          startapp: parsedParams.raw_param,
          post_id: parsedParams.post_id,
          admin_id: parsedParams.admin_id,
          tg_user_id: tgUserId,
          ref: parsedParams.ref || 'direct',
          platform: parsedParams.platform,
          source: 'mini_app',
          timestamp: new Date().toISOString()
        };

        if (tgUser) {
          requestData.user_data = {
            id: tgUser.id,
            username: tgUser.username,
            first_name: tgUser.first_name,
            last_name: tgUser.last_name,
            language_code: tgUser.language_code,
            is_premium: tgUser.is_premium || false
          };
        }

        setProgress(4, 'Обрабатываем…', 'Ожидаем ответ…');

        const response = await fetch(API_ENDPOINTS.apiTrack, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
          body: JSON.stringify(requestData)
        });

        let data = null;
        try { data = await response.json(); } catch { throw new Error('Сервер вернул некорректный ответ'); }

        if (!response.ok) throw new Error(data?.error || `HTTP ${response.status}`);

        if (!data?.success) {
          throw new Error(data?.error || 'Неизвестная ошибка сервера');
        }

        // Успех (и уникальный и повторный)
        if (data.click_counted && data.is_unique) {
          setProgress(5, 'Готово', 'Открываем чат…');
          setTimeout(() => openRedirectFromData(data), 650);
          return;
        }

        if (data.click_counted && !data.is_unique) {
          // FIX: теперь тоже редиректим по redirect_url / username
          setProgress(5, 'Уже откликались', 'Открываем чат…');
          setTimeout(() => openRedirectFromData(data), 650);
          return;
        }

        // если click_counted=false — это уже бэковая логика/ограничение
        showError('Отклик не был засчитан (сервер не подтвердил действие).');
        setProgress(4, 'Ошибка', 'Сервер не подтвердил засчитывание.');

        hasClicked = false;
      } catch (e) {
        console.error(e);
        showError(`Ошибка: ${e?.message || 'не удалось выполнить запрос'}`);
        setProgress(4, 'Ошибка', 'Пробуем открыть чат напрямую…');

        // запасной редирект
        setTimeout(() => {
          fadeOut();
          tg.openTelegramLink('tg://resolve?domain=shardlightspace_bot');
        }, 1100);

        hasClicked = false;
      }
    }

    // ============================================
    // INIT + AUTO FLOW
    // ============================================
    document.addEventListener('DOMContentLoaded', async () => {
      buildSteps();
      setProgress(1, 'Инициализация…', 'Запускаем мини-приложение…');

      const ok = initTelegram();
      if (!ok) {
        showError('Ошибка: Telegram WebApp не инициализируется.');
        setProgress(1, 'Ошибка', 'Не удалось запустить Telegram WebApp.');
        return;
      }

      setProgress(2, 'Проверяем параметры…', 'Считываем данные задания…');
      parsedParams = parseTelegramParams();

      if (!parsedParams || !parsedParams.parsed_successfully) {
        setProgress(2, 'Ошибка', 'Параметры задания не получены.');
        return;
      }

      // необязательная проверка health (не блокирует)
      setTimeout(async () => {
        try { await fetch(API_ENDPOINTS.health); } catch {}
      }, 250);

      // автостарт без кнопки
      setTimeout(() => handleClick(), 420);
    });
  </script>
</body>
</html>
